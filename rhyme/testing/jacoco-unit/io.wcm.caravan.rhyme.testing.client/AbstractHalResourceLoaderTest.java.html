<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractHalResourceLoaderTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rhyme - Testing Support</a> &gt; <a href="index.source.html" class="el_package">io.wcm.caravan.rhyme.testing.client</a> &gt; <span class="el_source">AbstractHalResourceLoaderTest.java</span></div><h1>AbstractHalResourceLoaderTest.java</h1><pre class="source lang-java linenums">package io.wcm.caravan.rhyme.testing.client;

import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;
import static com.github.tomakehurst.wiremock.client.WireMock.get;
import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.catchThrowable;

import java.io.IOException;
import java.net.URISyntaxException;
import java.net.UnknownHostException;
import java.time.Duration;

import javax.net.ssl.SSLHandshakeException;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.node.JsonNodeFactory;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.client.ResponseDefinitionBuilder;
import com.github.tomakehurst.wiremock.core.WireMockConfiguration;
import com.github.tomakehurst.wiremock.http.Fault;
import com.google.common.net.HttpHeaders;

import io.reactivex.rxjava3.core.Single;
import io.wcm.caravan.hal.resource.HalResource;
import io.wcm.caravan.rhyme.api.client.HalResourceLoaderBuilder;
import io.wcm.caravan.rhyme.api.common.HalResponse;
import io.wcm.caravan.rhyme.api.exceptions.HalApiClientException;
import io.wcm.caravan.rhyme.api.server.VndErrorResponseRenderer;
import io.wcm.caravan.rhyme.api.spi.HalResourceLoader;
import io.wcm.caravan.rhyme.api.spi.HttpClientSupport;
import wiremock.org.apache.http.client.utils.URIBuilder;

/**
 * A base class that you can extend if you are implementing your own {@link HalResourceLoader}
 * or {@link HttpClientSupport} classes.
 * It will run a extensive suite of tests where a {@link WireMockServer} will respond
 * with a variety of responses, including client/server errors and corrupt responses.
 */
<span class="fc" id="L45">public abstract class AbstractHalResourceLoaderTest {</span>

  protected static final String UNKNOWN_HOST_URL = &quot;http://foo.bar&quot;;

  protected static final String TEST_PATH = &quot;/test&quot;;

  private static WireMockServer wireMockServer;

  protected static String testUrl;
  protected static String sslTestUrl;

  @BeforeAll
  static void init() throws URISyntaxException {
<span class="fc" id="L58">    wireMockServer = new WireMockServer(new WireMockConfiguration().dynamicPort().dynamicHttpsPort());</span>
<span class="fc" id="L59">    wireMockServer.start();</span>

<span class="fc" id="L61">    testUrl = buildTestUrl(false);</span>
<span class="fc" id="L62">    sslTestUrl = buildTestUrl(true);</span>
<span class="fc" id="L63">  }</span>

  private static String buildTestUrl(boolean useSsl) throws URISyntaxException {

<span class="fc bfc" id="L67" title="All 2 branches covered.">    return new URIBuilder()</span>
<span class="fc" id="L68">        .setScheme(useSsl ? &quot;https&quot; : &quot;http&quot;)</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        .setHost(&quot;localhost&quot;)</span>
<span class="fc" id="L70">        .setPort(useSsl ? wireMockServer.httpsPort() : wireMockServer.port())</span>
<span class="fc" id="L71">        .setPath(TEST_PATH)</span>
<span class="fc" id="L72">        .build().toString();</span>
  }

  @AfterEach
  void tearDown() {
<span class="fc" id="L77">    wireMockServer.resetAll();</span>
<span class="fc" id="L78">  }</span>


  private static HalResource createHalResource() {

<span class="fc" id="L83">    return new HalResource(TEST_PATH).addState(createJsonResource());</span>
  }

  private static ObjectNode createJsonResource() {

<span class="fc" id="L88">    return JsonNodeFactory.instance.objectNode().put(&quot;föö&quot;, &quot;官ar&quot;);</span>
  }

  private static ResponseDefinitionBuilder get200HalResponseWithCacheControl(String... values) {

<span class="fc" id="L93">    HalResource hal = createHalResource();</span>

<span class="fc" id="L95">    ResponseDefinitionBuilder response = aResponse()</span>
<span class="fc" id="L96">        .withHeader(HttpHeaders.CONTENT_TYPE, HalResource.CONTENT_TYPE)</span>
<span class="fc" id="L97">        .withStatus(200)</span>
<span class="fc" id="L98">        .withBody(hal.getModel().toString());</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">    for (String value : values) {</span>
<span class="fc" id="L101">      response = response.withHeader(HttpHeaders.CACHE_CONTROL, value);</span>
    }

<span class="fc" id="L104">    return response;</span>
  }

  private static void stub200HalResponseWithMaxAge(Integer maxAge) {

<span class="fc" id="L109">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L110">        .willReturn(get200HalResponseWithCacheControl(&quot;max-age=&quot; + maxAge)));</span>
<span class="fc" id="L111">  }</span>

  private static void stub200HalResponseWithCacheControl(String... cacheControl) {

<span class="fc" id="L115">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L116">        .willReturn(get200HalResponseWithCacheControl(cacheControl)));</span>
<span class="fc" id="L117">  }</span>

  private static void stub200HalResponse() {

<span class="fc" id="L121">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L122">        .willReturn(get200HalResponseWithCacheControl()));</span>
<span class="fc" id="L123">  }</span>

  private static void stubHtmlResponseWithStatusCode(int statusCode) {

<span class="fc" id="L127">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L128">        .willReturn(aResponse()</span>
<span class="fc" id="L129">            .withStatus(statusCode)</span>
<span class="fc" id="L130">            .withHeader(HttpHeaders.CONTENT_TYPE, &quot;text/html&quot;)</span>
<span class="fc" id="L131">            .withBody(&quot;&lt;h1&gt;This is an HTML document&lt;/h1&gt;&quot;)));</span>
<span class="fc" id="L132">  }</span>

  private static void stubJsonResponseWithStatusCode(int statusCode) {

<span class="fc" id="L136">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L137">        .willReturn(aResponse()</span>
<span class="fc" id="L138">            .withStatus(statusCode)</span>
<span class="fc" id="L139">            .withHeader(HttpHeaders.CONTENT_TYPE, &quot;application/json&quot;)</span>
<span class="fc" id="L140">            .withBody(createJsonResource().toString())));</span>
<span class="fc" id="L141">  }</span>

  private static void stubErrorResponseWithoutContentType(int statusCode) {

<span class="fc" id="L145">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L146">        .willReturn(aResponse()</span>
<span class="fc" id="L147">            .withStatus(statusCode)</span>
<span class="fc" id="L148">            .withBody(&quot;Foo&quot;)));</span>
<span class="fc" id="L149">  }</span>

  private static void stub500VndErrorResponse() {

<span class="fc" id="L153">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L154">        .willReturn(aResponse()</span>
<span class="fc" id="L155">            .withStatus(500)</span>
<span class="fc" id="L156">            .withHeader(HttpHeaders.CONTENT_TYPE.toLowerCase(), VndErrorResponseRenderer.CONTENT_TYPE)</span>
<span class="fc" id="L157">            .withBody(&quot;{}&quot;)));</span>
<span class="fc" id="L158">  }</span>

  private void stubEmptyResponseWithStatusCode(int statusCode) {

<span class="fc" id="L162">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L163">        .willReturn(aResponse()</span>
<span class="fc" id="L164">            .withStatus(statusCode)));</span>
<span class="fc" id="L165">  }</span>

  protected void stubFaultyResponseWithStatusCode(int statusCode, Fault fault) {

<span class="fc" id="L169">    wireMockServer.stubFor(get(urlEqualTo(TEST_PATH))</span>
<span class="fc" id="L170">        .willReturn(aResponse()</span>
<span class="fc" id="L171">            .withStatus(statusCode)</span>
<span class="fc" id="L172">            .withFault(fault)));</span>
<span class="fc" id="L173">  }</span>


  /**
   * Implement this to return your implementation of {@link HalResourceLoader},
   * or (if you are implementing {@link HttpClientSupport} then use
   * {@link HalResourceLoaderBuilder#withCustomHttpClient(HttpClientSupport)} to
   * create the instance under test
   * @return the instance to be tested
   */
  protected abstract HalResourceLoader createLoaderUnderTest();

  protected HalResponse loadResource() {

<span class="fc" id="L187">    String uri = testUrl;</span>

<span class="fc" id="L189">    return createLoaderUnderTest().getHalResource(uri).blockingGet();</span>
  }

  protected HalApiClientException loadResourceAndExpectClientException() {

<span class="fc" id="L194">    return loadResourceAndExpectClientException(testUrl);</span>
  }

  protected HalApiClientException loadResourceAndExpectClientException(String url) {
<span class="fc" id="L198">    Single&lt;HalResponse&gt; rxResponse = createLoaderUnderTest().getHalResource(url);</span>

<span class="pc" id="L200">    Throwable ex = catchThrowable(() -&gt; rxResponse.blockingGet());</span>

<span class="fc" id="L202">    assertThat(ex)</span>
<span class="fc" id="L203">        .isInstanceOf(HalApiClientException.class)</span>
<span class="fc" id="L204">        .hasMessageStartingWith(&quot;HAL client request to&quot;)</span>
<span class="fc" id="L205">        .hasMessageContaining(&quot;has failed&quot;);</span>

<span class="fc" id="L207">    return (HalApiClientException)ex;</span>
  }

  @Test
  public void response_code_should_be_set_for_200_hal_response() throws Exception {

<span class="fc" id="L213">    stub200HalResponse();</span>

<span class="fc" id="L215">    HalResponse response = loadResource();</span>

<span class="fc" id="L217">    assertThat(response.getStatus())</span>
<span class="fc" id="L218">        .isEqualTo(200);</span>
<span class="fc" id="L219">  }</span>

  @Test
  public void content_type_should_be_set_for_200_hal_response() throws Exception {

<span class="fc" id="L224">    stub200HalResponse();</span>

<span class="fc" id="L226">    HalResponse response = loadResource();</span>

<span class="fc" id="L228">    assertThat(response.getContentType())</span>
<span class="fc" id="L229">        .isEqualTo(HalResource.CONTENT_TYPE);</span>
<span class="fc" id="L230">  }</span>

  @Test
  public void body_should_be_set_for_200_hal_response() throws Exception {

<span class="fc" id="L235">    stub200HalResponse();</span>

<span class="fc" id="L237">    HalResponse response = loadResource();</span>

<span class="fc" id="L239">    assertThat(response.getBody())</span>
<span class="fc" id="L240">        .isNotNull();</span>

<span class="fc" id="L242">    assertThat(response.getBody().getModel())</span>
<span class="fc" id="L243">        .isEqualTo(createHalResource().getModel());</span>
<span class="fc" id="L244">  }</span>

  @Test
  public void maxAge_should_be_null_for_200_hal_response_without_cache_control() throws Exception {

<span class="fc" id="L249">    stub200HalResponseWithCacheControl();</span>

<span class="fc" id="L251">    HalResponse response = loadResource();</span>

<span class="fc" id="L253">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L254">        .isNull();</span>
<span class="fc" id="L255">  }</span>

  @Test
  public void non_zero_maxAge_should_be_taken_from_200_hal_response() throws Exception {

<span class="fc" id="L260">    stub200HalResponseWithMaxAge(100);</span>

<span class="fc" id="L262">    HalResponse response = loadResource();</span>

<span class="fc" id="L264">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L265">        .isEqualTo(100);</span>
<span class="fc" id="L266">  }</span>

  @Test
  public void zero_maxAge_should_be_taken_from_200_hal_response() throws Exception {

<span class="fc" id="L271">    stub200HalResponseWithMaxAge(0);</span>

<span class="fc" id="L273">    HalResponse response = loadResource();</span>

<span class="fc" id="L275">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L276">        .isEqualTo(0);</span>
<span class="fc" id="L277">  }</span>

  @Test
  public void maxAge_should_be_found_if_seperated_in_multiple_cache_control_headers() throws Exception {

<span class="fc" id="L282">    stub200HalResponseWithCacheControl(&quot;public&quot;, &quot;no-transform&quot;, &quot;max-age=86400&quot;);</span>

<span class="fc" id="L284">    HalResponse response = loadResource();</span>

<span class="fc" id="L286">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L287">        .isEqualTo(86400);</span>
<span class="fc" id="L288">  }</span>

  @Test
  public void immutable_should_override_max_age() throws Exception {

<span class="fc" id="L293">    stub200HalResponseWithCacheControl(&quot;public&quot;, &quot;max-age=86400&quot;, &quot;immutable&quot;);</span>

<span class="fc" id="L295">    HalResponse response = loadResource();</span>

<span class="fc" id="L297">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L298">        .isEqualTo(Duration.ofDays(365).getSeconds());</span>
<span class="fc" id="L299">  }</span>

  @Test
  public void maxAge_should_be_ignored_if_it_contains_invalid_value() throws Exception {

<span class="fc" id="L304">    stub200HalResponseWithCacheControl(&quot;max-age=foo&quot;);</span>

<span class="fc" id="L306">    HalResponse response = loadResource();</span>

<span class="fc" id="L308">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L309">        .isNull();</span>
<span class="fc" id="L310">  }</span>

  @Test
  public void maxAge_should_be_properly_capped_to_max_int_value() throws Exception {

<span class="fc" id="L315">    stub200HalResponseWithCacheControl(&quot;max-age=&quot; + (1000l + Integer.MAX_VALUE));</span>

<span class="fc" id="L317">    HalResponse response = loadResource();</span>

<span class="fc" id="L319">    assertThat(response.getMaxAge())</span>
<span class="fc" id="L320">        .isEqualTo(Integer.MAX_VALUE);</span>
<span class="fc" id="L321">  }</span>

  @Test
  public void status_code_should_be_present_in_HalApiClientException_for_non_ok_response() throws Exception {

<span class="fc" id="L326">    stubHtmlResponseWithStatusCode(503);</span>

<span class="fc" id="L328">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L330">    assertThat(ex.getStatusCode())</span>
<span class="fc" id="L331">        .isEqualTo(503);</span>
<span class="fc" id="L332">  }</span>

  @Test
  public void content_type_should_be_set_for_500_vnd_error_response() throws Exception {

<span class="fc" id="L337">    stub500VndErrorResponse();</span>

<span class="fc" id="L339">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L341">    assertThat(ex.getErrorResponse().getContentType())</span>
<span class="fc" id="L342">        .isEqualTo(VndErrorResponseRenderer.CONTENT_TYPE);</span>
<span class="fc" id="L343">  }</span>

  @Test
  public void content_type_should_be_null_if_not_present_in_error_response() throws Exception {

<span class="fc" id="L348">    stubErrorResponseWithoutContentType(501);</span>

<span class="fc" id="L350">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L352">    assertThat(ex.getErrorResponse().getContentType())</span>
<span class="fc" id="L353">        .isNull();</span>
<span class="fc" id="L354">  }</span>

  @Test
  public void request_url_should_be_present_in_HalApiClientException_for_non_ok_response() throws Exception {

<span class="fc" id="L359">    stubHtmlResponseWithStatusCode(503);</span>

<span class="fc" id="L361">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L363">    assertThat(ex.getRequestUrl())</span>
<span class="fc" id="L364">        .isEqualTo(testUrl);</span>
<span class="fc" id="L365">  }</span>

  @Test
  public void error_body_should_be_null_in_HalApiClientException_for_non_ok_html_response() throws Exception {

<span class="fc" id="L370">    stubHtmlResponseWithStatusCode(503);</span>

<span class="fc" id="L372">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L374">    assertThat(ex.getErrorResponse())</span>
<span class="fc" id="L375">        .isNotNull();</span>
<span class="fc" id="L376">    assertThat(ex.getErrorResponse().getBody())</span>
<span class="fc" id="L377">        .isNull();</span>
<span class="fc" id="L378">  }</span>

  @Test
  public void error_body_should_be_null_in_HalApiClientException_for_non_ok_response_without_body() throws Exception {

<span class="fc" id="L383">    stubEmptyResponseWithStatusCode(204);</span>

<span class="fc" id="L385">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L387">    assertThat(ex.getErrorResponse())</span>
<span class="fc" id="L388">        .isNotNull();</span>
<span class="fc" id="L389">    assertThat(ex.getErrorResponse().getBody())</span>
<span class="fc" id="L390">        .isNull();</span>
<span class="fc" id="L391">  }</span>

  @Test
  public void error_body_should_be_present_in_HalApiClientException_for_non_ok_json_response() throws Exception {

<span class="fc" id="L396">    stubJsonResponseWithStatusCode(503);</span>

<span class="fc" id="L398">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L400">    assertThat(ex.getErrorResponse())</span>
<span class="fc" id="L401">        .isNotNull();</span>

<span class="fc" id="L403">    HalResource body = ex.getErrorResponse().getBody();</span>

<span class="fc" id="L405">    assertThat(body)</span>
<span class="fc" id="L406">        .isNotNull();</span>
<span class="fc" id="L407">    assertThat(body.getModel())</span>
<span class="fc" id="L408">        .isEqualTo(createJsonResource());</span>
<span class="fc" id="L409">  }</span>

  @Test
  public void status_code_should_be_200_in_HalApiClientException_for_failure_to_parse_json() throws Exception {

<span class="fc" id="L414">    stubHtmlResponseWithStatusCode(200);</span>

<span class="fc" id="L416">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L418">    assertThat(ex.getStatusCode())</span>
<span class="fc" id="L419">        .isEqualTo(200);</span>
<span class="fc" id="L420">  }</span>

  @Test
  public void request_url_should_be_present_in_HalApiClientException_for_failure_to_parse_json() throws Exception {

<span class="fc" id="L425">    stubHtmlResponseWithStatusCode(200);</span>

<span class="fc" id="L427">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L429">    assertThat(ex.getRequestUrl())</span>
<span class="fc" id="L430">        .isEqualTo(testUrl);</span>
<span class="fc" id="L431">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_failure_to_parse_json() throws Exception {

<span class="fc" id="L436">    stubHtmlResponseWithStatusCode(200);</span>

<span class="fc" id="L438">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L440">    assertThat(ex)</span>
<span class="fc" id="L441">        .hasRootCauseInstanceOf(JsonProcessingException.class);</span>

<span class="fc" id="L443">    assertThat(ex.getCause())</span>
<span class="fc" id="L444">        .hasMessage(&quot;An HTTP response with status code 200 was retrieved, but the body could not be successfully read and parsed as a JSON document&quot;)</span>
<span class="fc" id="L445">        .hasRootCauseInstanceOf(IOException.class);</span>
<span class="fc" id="L446">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_failure_to_parse_empty_string() throws Exception {

<span class="fc" id="L451">    stubEmptyResponseWithStatusCode(200);</span>

<span class="fc" id="L453">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L455">    assertThat(ex)</span>
<span class="fc" id="L456">        .hasMessageContaining(&quot;has failed because the response body is malformed&quot;);</span>

<span class="fc" id="L458">    assertThat(ex.getCause())</span>
<span class="fc" id="L459">        .hasMessage(&quot;An HTTP response with status code 200 was retrieved, but the body could not be successfully read and parsed as a JSON document&quot;)</span>
<span class="fc" id="L460">        .hasRootCauseMessage(&quot;The response body was completely empty (or consisted only of whitespace)&quot;);</span>
<span class="fc" id="L461">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_malformed_200_response() throws Exception {

<span class="fc" id="L466">    stubFaultyResponseWithStatusCode(200, Fault.MALFORMED_RESPONSE_CHUNK);</span>

<span class="fc" id="L468">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

    // the behaviour for this edge cases varies between implementations:
    // sometimes the response code is sucessfully extracted, sometimes not.
    // the only thing they have in common is that at some point, an IOException is caught
<span class="fc" id="L473">    assertThat(ex)</span>
<span class="fc" id="L474">        .hasRootCauseInstanceOf(IOException.class);</span>
<span class="fc" id="L475">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_connection_reset_on_200_response() throws Exception {

<span class="fc" id="L480">    stubFaultyResponseWithStatusCode(200, Fault.CONNECTION_RESET_BY_PEER);</span>

<span class="fc" id="L482">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L484">    assertThat(ex.getStatusCode())</span>
<span class="fc" id="L485">        .isEqualTo(null);</span>

<span class="fc" id="L487">    assertThat(ex)</span>
<span class="fc" id="L488">        .hasMessageContaining(&quot;has failed before a status code was available&quot;)</span>
<span class="fc" id="L489">        .hasRootCauseInstanceOf(IOException.class);</span>
<span class="fc" id="L490">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_random_data_on_200_response() throws Exception {

<span class="fc" id="L495">    stubFaultyResponseWithStatusCode(200, Fault.RANDOM_DATA_THEN_CLOSE);</span>

<span class="fc" id="L497">    HalApiClientException ex = loadResourceAndExpectClientException();</span>

<span class="fc" id="L499">    assertThat(ex.getStatusCode())</span>
<span class="fc" id="L500">        .isEqualTo(null);</span>

<span class="fc" id="L502">    assertThat(ex)</span>
<span class="fc" id="L503">        .hasMessageContaining(&quot;has failed before a status code was available&quot;);</span>
<span class="fc" id="L504">  }</span>

  @Test
  public void status_code_should_be_null_in_HalApiClientException_for_network_errors() throws Exception {

<span class="fc" id="L509">    HalApiClientException ex = loadResourceAndExpectClientException(UNKNOWN_HOST_URL);</span>

<span class="fc" id="L511">    assertThat(ex.getStatusCode())</span>
<span class="fc" id="L512">        .isNull();</span>
<span class="fc" id="L513">  }</span>

  @Test
  public void request_url_should_be_present_in_HalApiClientException_for_network_errors() throws Exception {

<span class="fc" id="L518">    HalApiClientException ex = loadResourceAndExpectClientException(UNKNOWN_HOST_URL);</span>

<span class="fc" id="L520">    assertThat(ex.getRequestUrl())</span>
<span class="fc" id="L521">        .isEqualTo(UNKNOWN_HOST_URL);</span>
<span class="fc" id="L522">  }</span>

  @Test
  public void error_body_should_be_null_in_HalApiClientException_for_network_errors() throws Exception {

<span class="fc" id="L527">    HalApiClientException ex = loadResourceAndExpectClientException(UNKNOWN_HOST_URL);</span>

<span class="fc" id="L529">    assertThat(ex.getErrorResponse())</span>
<span class="fc" id="L530">        .isNotNull();</span>
<span class="fc" id="L531">    assertThat(ex.getErrorResponse().getBody())</span>
<span class="fc" id="L532">        .isNull();</span>
<span class="fc" id="L533">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_for_network_errors() throws Exception {

<span class="fc" id="L538">    HalApiClientException ex = loadResourceAndExpectClientException(UNKNOWN_HOST_URL);</span>

<span class="fc" id="L540">    assertThat(ex)</span>
<span class="fc" id="L541">        .hasCauseInstanceOf(UnknownHostException.class);</span>
<span class="fc" id="L542">  }</span>

  @Test
  public void cause_should_be_present_in_HalApiClientException_for_for_ssl_errors() throws Exception {

<span class="fc" id="L547">    HalApiClientException ex = loadResourceAndExpectClientException(sslTestUrl);</span>

<span class="fc" id="L549">    assertThat(ex)</span>
<span class="fc" id="L550">        .hasCauseInstanceOf(SSLHandshakeException.class);</span>
<span class="fc" id="L551">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>